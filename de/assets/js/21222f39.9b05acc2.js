"use strict";(self.webpackChunkdocs_docusaurus=self.webpackChunkdocs_docusaurus||[]).push([[3610],{3905:(e,t,a)=>{a.d(t,{Zo:()=>p,kt:()=>h});var n=a(67294);function o(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function s(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function l(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?s(Object(a),!0).forEach((function(t){o(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):s(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function i(e,t){if(null==e)return{};var a,n,o=function(e,t){if(null==e)return{};var a,n,o={},s=Object.keys(e);for(n=0;n<s.length;n++)a=s[n],t.indexOf(a)>=0||(o[a]=e[a]);return o}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(n=0;n<s.length;n++)a=s[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(o[a]=e[a])}return o}var r=n.createContext({}),c=function(e){var t=n.useContext(r),a=t;return e&&(a="function"==typeof e?e(t):l(l({},t),e)),a},p=function(e){var t=c(e.components);return n.createElement(r.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var a=e.components,o=e.mdxType,s=e.originalType,r=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),m=c(a),h=o,u=m["".concat(r,".").concat(h)]||m[h]||d[h]||s;return a?n.createElement(u,l(l({ref:t},p),{},{components:a})):n.createElement(u,l({ref:t},p))}));function h(e,t){var a=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var s=a.length,l=new Array(s);l[0]=m;var i={};for(var r in t)hasOwnProperty.call(t,r)&&(i[r]=t[r]);i.originalType=e,i.mdxType="string"==typeof e?e:o,l[1]=i;for(var c=2;c<s;c++)l[c]=a[c];return n.createElement.apply(null,l)}return n.createElement.apply(null,a)}m.displayName="MDXCreateElement"},15806:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>r,contentTitle:()=>l,default:()=>d,frontMatter:()=>s,metadata:()=>i,toc:()=>c});var n=a(87462),o=(a(67294),a(3905));const s={slug:"december-2022",title:"2022 December: One VM to Rule Them All!",authors:"gtnardy",tags:["updates"],image:"/img/blog/2022-december/december-news.webp"},l=void 0,i={permalink:"/de/blog/december-2022",editUrl:"https://github.com/nanos-world/docs/edit/master/blog/2023-01-04-december.md",source:"@site/i18n/de/docusaurus-plugin-content-blog/2023-01-04-december.md",title:"2022 December: One VM to Rule Them All!",description:"One Lua Virtual Machine to Rule Them All!",date:"2023-01-04T00:00:00.000Z",formattedDate:"4. Januar 2023",tags:[{label:"updates",permalink:"/de/blog/tags/updates"}],readingTime:8.03,hasTruncateMarker:!1,authors:[{name:"Gabriel T. Nardy",title:"nanos world developer (SyedMuhammad)",url:"https://twitter.com/gtnardy",imageURL:"/img/blog/gtnardy.jpg",key:"gtnardy"}],frontMatter:{slug:"december-2022",title:"2022 December: One VM to Rule Them All!",authors:"gtnardy",tags:["updates"],image:"/img/blog/2022-december/december-news.webp"},nextItem:{title:"2022 November: Entity System, UDS & UE5.1!",permalink:"/de/blog/november-2022"}},r={authorsImageUrls:[void 0]},c=[{value:"One Lua Virtual Machine",id:"one-lua-virtual-machine",level:2},{value:"Call &amp; Export",id:"call--export",level:3},{value:"Inherited Classes",id:"inherited-classes",level:3},{value:"Library Package Type",id:"library-package-type",level:3},{value:"RequirePackage",id:"requirepackage",level:3},{value:"GameMode Settings",id:"gamemode-settings",level:2},{value:"Configuration Files",id:"configuration-files",level:2},{value:"Meta Block",id:"meta-block",level:3},{value:"Package",id:"package",level:3},{value:"Configuration Images",id:"configuration-images",level:2},{value:"New Static Classes",id:"new-static-classes",level:2},{value:"Renamed Events",id:"renamed-events",level:2},{value:"Assets Plugin Content",id:"assets-plugin-content",level:2},{value:"Store Improvements",id:"store-improvements",level:2},{value:"Conclusion",id:"conclusion",level:2}],p={toc:c};function d(e){let{components:t,...s}=e;return(0,o.kt)("wrapper",(0,n.Z)({},p,s,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"One Lua Virtual Machine to Rule Them All!")),(0,o.kt)("p",null,(0,o.kt)("img",{src:a(40830).Z,width:"800",height:"320"})),(0,o.kt)("h2",{id:"one-lua-virtual-machine"},"One Lua Virtual Machine"),(0,o.kt)("p",null,"After much analysis, study and refactoring. I am happily introducing the new way the Packages will work! This was heavily motivated by the lack of possibility of creating extensions or customized items in an easy way."),(0,o.kt)("p",null,(0,o.kt)("img",{src:a(64272).Z,width:"976",height:"549"})),(0,o.kt)("p",null,"In addition to the last new Entity System update, this change will heavily add to the possibilities of modding & scripting capabilities to nanos world!"),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},"Those changes are meant to have as little as possible impact and breaking changes, all tests I did so far assured everything is still backward compatible!")),(0,o.kt)("p",null,"So far, we had one VM (Virtual Machine - or ",(0,o.kt)("inlineCode",{parentName:"p"},"lua_State"),") created per Package. This caused each Package to be completely isolated from each other. Therefore it was necessary to create mechanisms for communication between the Packages, such as ",(0,o.kt)("strong",{parentName:"p"},"Events")," and ",(0,o.kt)("strong",{parentName:"p"},"Package.Export/Package.Call")," methods, which allowed (in a limited way) Packages to communicate with each other."),(0,o.kt)("p",null,"But as mentioned, this brought many limitations, such as it was not possible for Packages to access variables or call functions directly from other Packages, or even worse (which become more evident from the last update of Entity System): It was not possible to share custom classes between Packages!"),(0,o.kt)("p",null,"However now all of this will be solved! I reworked the entire internal scripting system, and now instead of having a new virtual machine per Package, we will have a virtualized sandboxed environment (using Lua environment ",(0,o.kt)("inlineCode",{parentName:"p"},"_ENV")," feature), separating the scope of each Package but allowing them to access a global shared environment!"),(0,o.kt)("p",null,"This will allow the Packages to define classes, expose functions and share libraries globally! So that everyone else can use without the need for workaround mechanisms to do so!"),(0,o.kt)("p",null,"Now, for example you can just load additional scripts together the ",(0,o.kt)("inlineCode",{parentName:"p"},"sandbox")," game-mode which loads custom Classes of tools or weapons, and those will appear automatically in the Spawn Menu, no need for manually adding them anymore!"),(0,o.kt)("p",null,"Each Package will still have it's own sub-global environment, so defining global variables or functions will not make them available to other packages immediately."),(0,o.kt)("h3",{id:"call--export"},"Call & Export"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"Package.Call")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"Package.Export")," are not necessary in the traditional way anymore. As now we can share the global environment, we can define methods and expose them to be called directly, without the need to ",(0,o.kt)("inlineCode",{parentName:"p"},"Package.Call")," them."),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"Package.Export"),' will still exist and work similarly. But now it will be possible to "expose" any value to the global scope! Example:'),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-lua",metastring:"title=package-01/Server/Index.lua",title:"package-01/Server/Index.lua"},'local my_table = { 123, 456 }\n\nfunction DoSomething(var1)\n    return var1 + 123\nend\n\nPackage.Export("MyTable", my_table)\nPackage.Export("DoSomething", DoSomething)\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-lua",metastring:"title=package-02/Server/Index.lua",title:"package-02/Server/Index.lua"},"Console.Log(MyTable[1])\n-- 123\n\nConsole.Log(DoSomething(456))\n-- 579\n")),(0,o.kt)("h3",{id:"inherited-classes"},"Inherited Classes"),(0,o.kt)("p",null,"Now all Inherited Classes will be available to all Packages, as they will be created and exposed to the Global scope automatically."),(0,o.kt)("p",null,"The first parameter of it will now be used as the variable name to set the class in the global scope. Also, it just got a new optional 2nd parameter to define a custom table contained custom values to be set in the class table before it's created:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-lua"},'-- Note we are assigning the return of Inherit to a variable called\n-- MyPropClassLocal, but also MyPropClass will be defined globally\n-- as being our class, both variables points to the same Class table\nMyPropClassLocal = Prop.Inherit("MyPropClass", {\n    "my_custom_value" = 123,\n    "my_another_value" = "hello"\n})\n\nlocal val = MyPropClass.my_custom_value\n-- val == 123\n')),(0,o.kt)("p",null,"We've also added a new static event for getting when a new Inherited Class is registered: ",(0,o.kt)("inlineCode",{parentName:"p"},"ClassRegister"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-lua"},'Prop.Subscribe("ClassRegister", function(class)\n    -- Do something with the new class\nend)\n')),(0,o.kt)("h3",{id:"library-package-type"},"Library Package Type"),(0,o.kt)("p",null,"With this new way Package work, ",(0,o.kt)("inlineCode",{parentName:"p"},"library")," types are no longer needed. As now we can communicate directly with other packages with exposed global methods, we can just define the methods to be exported with ",(0,o.kt)("inlineCode",{parentName:"p"},"Package.Export")," and use them whenever we want."),(0,o.kt)("p",null,'In this way we will only have two types of "lua script" Packages: ',(0,o.kt)("inlineCode",{parentName:"p"},"game-mode")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"script"),". All existing ",(0,o.kt)("inlineCode",{parentName:"p"},"library")," packages will be automatically converted to ",(0,o.kt)("inlineCode",{parentName:"p"},"script")," when loaded."),(0,o.kt)("h3",{id:"requirepackage"},"RequirePackage"),(0,o.kt)("p",null,"Therefore, ",(0,o.kt)("inlineCode",{parentName:"p"},"Package.RequirePackage")," will becomes unnecessary as well. As we can now reuse the same script globally, this method will be depreciated in favor of adding your package in the ",(0,o.kt)("inlineCode",{parentName:"p"},"package_dependencies")," list of your Package's Package.toml."),(0,o.kt)("p",null,(0,o.kt)("em",{parentName:"p"},"Package requiring")," the default ",(0,o.kt)("inlineCode",{parentName:"p"},"nanos-world-vehicles")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"nanos-world-weapons")," will load them as a standalone Package, as now they ",(0,o.kt)("strong",{parentName:"p"},"export")," the ",(0,o.kt)("inlineCode",{parentName:"p"},"NanosWorldWeapons")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"NanosWorldVehicles")," tables globally."),(0,o.kt)("h2",{id:"gamemode-settings"},"GameMode Settings"),(0,o.kt)("p",null,"We are introducing the concept of custom settings for game-modes! These settings can be defined in ",(0,o.kt)("strong",{parentName:"p"},"Package.toml")," like that:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-toml"},'# game-mode custom settings configurations\n[custom_settings]\n    my_toggle = { label = "enable PVP", type = "boolean", description = "whether to enable PVP or not", default = true }\n    my_text_input = { label = "type anything", type = "text", description = "custom text!", default = "hello world!" }\n')),(0,o.kt)("p",null,"These settings can be configured through server arguments ",(0,o.kt)("inlineCode",{parentName:"p"},"--custom_settings \"my_toggle = true, my_text_input = 'awesome text!', ...\""),", or through the New Game screen, which parses and displays the configuration dynamically when creating a new game:"),(0,o.kt)("p",null,(0,o.kt)("img",{src:a(11586).Z,width:"1913",height:"1025"})),(0,o.kt)("p",null,"The values defined can be accessed through the new method ",(0,o.kt)("inlineCode",{parentName:"p"},"Server.GetCustomSettings()"),"."),(0,o.kt)("p",null,"Please refer to the updated ",(0,o.kt)("a",{parentName:"p",href:"https://docs.nanos.world/docs/next/core-concepts/packages/packages-guide#custom-settings"},"Documentation Page")," for more information."),(0,o.kt)("h2",{id:"configuration-files"},"Configuration Files"),(0,o.kt)("p",null,"As announced on previous blogs, the format of the configuration files are changing in the next update!"),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"All ",(0,o.kt)("strong",{parentName:"p"},"Package.toml")," and ",(0,o.kt)("strong",{parentName:"p"},"Assets.toml")," in the old format will automatically self-convert to the new format as soon as they load for the first time.")),(0,o.kt)("h3",{id:"meta-block"},"Meta Block"),(0,o.kt)("p",null,"Now we have a new common header among all ",(0,o.kt)("strong",{parentName:"p"},"Assets.toml")," and ",(0,o.kt)("strong",{parentName:"p"},"Package.toml"),": ",(0,o.kt)("inlineCode",{parentName:"p"},"[meta]"),"."),(0,o.kt)("p",null,"It will have the following format, which will be used to define general configurations mainly used by the store:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-toml",metastring:"reference",reference:!0},"https://github.com/nanos-world/nanos-world-server/blob/main/_meta.toml\n")),(0,o.kt)("h3",{id:"package"},"Package"),(0,o.kt)("p",null,"For the Packages, we will have a new format to differentiate their Types. Each Package type will have an independent and different block of configurations. Now the Package type will be determined by defining a block ",(0,o.kt)("inlineCode",{parentName:"p"},"[game_mode]"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"[script]")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"[loading-screen]"),"."),(0,o.kt)("p",null,"This is how a game-mode Package.toml will look like:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-toml",metastring:"reference",reference:!0},"https://github.com/nanos-world/nanos-world-server/blob/main/_game_mode.toml\n")),(0,o.kt)("h2",{id:"configuration-images"},"Configuration Images"),(0,o.kt)("p",null,"As you may have noticed, there is no more setting ",(0,o.kt)("inlineCode",{parentName:"p"},"image")," on ",(0,o.kt)("strong",{parentName:"p"},"Package.toml"),", the same applies to ",(0,o.kt)("strong",{parentName:"p"},"Assets.toml")," and for the server image in the ",(0,o.kt)("strong",{parentName:"p"},"Config.toml"),"."),(0,o.kt)("p",null,"Now, the images should be physically placed next to the ",(0,o.kt)("strong",{parentName:"p"},".toml")," file with the name ",(0,o.kt)("inlineCode",{parentName:"p"},"Package.jpg"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"Assets.jpg")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"Server.jpg"),"."),(0,o.kt)("p",null,"This is a standardization to solve the image inconsistency between the store and the config file, as well as to avoid external and malicious links to be placed there. But this brings the drawback that only dedicated servers can display an image on the Server List from now on."),(0,o.kt)("h2",{id:"new-static-classes"},"New Static Classes"),(0,o.kt)("p",null,"Finally we are releasing the update with all the Static Class refactoring! This will give us a great new organization to find things at the docs, as now specific methods will be grouped into classes with names that make sense!"),(0,o.kt)("p",null,"List of all new Static Classes:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://docs.nanos.world/docs/next/scripting-reference/static-classes/chat"},"\ud83d\udcac Chat")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://docs.nanos.world/docs/next/scripting-reference/static-classes/console"},"\ud83d\udd24 Console")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://docs.nanos.world/docs/next/scripting-reference/static-classes/debug"},"\ud83d\udc1b Debug")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://docs.nanos.world/docs/next/scripting-reference/static-classes/discord"},"\u260e\ufe0f Discord")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://docs.nanos.world/docs/next/scripting-reference/static-classes/level"},"\ud83c\udfdd\ufe0f Level")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://docs.nanos.world/docs/next/scripting-reference/static-classes/navigation"},"\ud83d\udea2 Navigation")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://docs.nanos.world/docs/next/scripting-reference/static-classes/postprocess"},"\ud83d\uddbc\ufe0f PostProcess")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://docs.nanos.world/docs/next/scripting-reference/static-classes/sky"},"\ud83c\udf05 Sky")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://docs.nanos.world/docs/next/scripting-reference/static-classes/steam"},"\ud83c\udfae Steam")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://docs.nanos.world/docs/next/scripting-reference/static-classes/trace"},"\ud83d\udd0d Trace")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://docs.nanos.world/docs/next/scripting-reference/static-classes/viewport"},"\ud83d\udcfa Viewport"))),(0,o.kt)("p",null,"Also, ",(0,o.kt)("a",{parentName:"p",href:"https://docs.nanos.world/docs/next/scripting-reference/static-classes/input"},"\ud83d\udd79\ufe0f Input")," got a bunch of new methods and events as well from Client."),(0,o.kt)("p",null,"Many of the methods from ",(0,o.kt)("a",{parentName:"p",href:"https://docs.nanos.world/docs/next/scripting-reference/static-classes/client"},"\u2328\ufe0f Client")," and the old ",(0,o.kt)("strong",{parentName:"p"},"\ud83c\udf0d World")," were migrated to those classes! Check their pages for accurate information!"),(0,o.kt)("h2",{id:"renamed-events"},"Renamed Events"),(0,o.kt)("p",null,"Due our last poll, we are starting to change all events names which were with wrong names. We are standardizing them to the present tense, so events like ",(0,o.kt)("inlineCode",{parentName:"p"},"CharacterEntered")," will be renamed to ",(0,o.kt)("inlineCode",{parentName:"p"},"CharacterEnter")," for example."),(0,o.kt)("p",null,"All changes will keep the old event working as deprecated. Please get attention to the new warnings to update them to the newer version!"),(0,o.kt)("h2",{id:"assets-plugin-content"},"Assets Plugin Content"),(0,o.kt)("p",null,"Now it is possible to create Asset Packs from Plugin Content, this will be the preferred way of creating content from now on as it prevents assets paths colliding with others."),(0,o.kt)("p",null,"For that, we added a new setting in ",(0,o.kt)("strong",{parentName:"p"},"Assets.toml")," to define if the Asset Pack is a plugin content: ",(0,o.kt)("inlineCode",{parentName:"p"},"is_plugin_content"),"."),(0,o.kt)("p",null,"Please refer to the updated ",(0,o.kt)("a",{parentName:"p",href:"https://docs.nanos.world/docs/next/assets-modding/creating-assets/importing-assets"},"Documentation Page")," for more information."),(0,o.kt)("h2",{id:"store-improvements"},"Store Improvements"),(0,o.kt)("p",null,"Last month MegaThorx launched an update to the store, which greatly improves the upload flow of new versions. Now we have a progress bar, as well as special scripts to verify for syntax errors and potential problems. More features will be added in the future as well!"),(0,o.kt)("p",null,(0,o.kt)("img",{src:a(97265).Z,width:"1259",height:"723"})),(0,o.kt)("h2",{id:"conclusion"},"Conclusion"),(0,o.kt)("p",null,"I was not very much satisfied on how nanos world was handling the possibilities of modding and scripting. It felt very limited and non natural the way scripters had to do to make packages to communicate with each other, it wasn't allowing much customization or extensibility."),(0,o.kt)("p",null,"With the last month's ",(0,o.kt)("a",{parentName:"p",href:"https://docs.nanos.world/docs/next/core-concepts/scripting/inheriting-classes"},"Entity System")," and now with this change to how Packages work, I feel that a huge door of possibilities has just opened even more, which will give a good breath to new things to be added!"),(0,o.kt)("p",null,"An excellent example of what now is possible to achieve is creating a blank ",(0,o.kt)("inlineCode",{parentName:"p"},"script")," package with a custom special inherited Weapon, and just loading the Sandbox game-mode together with your script to make it show up in the Spawn Menu, without needing any special call or workaround! This is huge and tie all the remaining knots! \ud83e\udd73"),(0,o.kt)("p",null,"This change to a single VM was a big change, at first I thought it was not going to work, but after done and performing tests I was very surprised and happy with the results! Now we have to refine and improve it even more!"),(0,o.kt)("p",null,"Modding goes brrr!! Thank you for the support! See you next month! \ud83d\udcaa\ud83d\udcaa"))}d.isMDXComponent=!0},40830:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/december-news-d3aff08ec5aef08f0426ecb558a5de57.webp"},64272:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/lua-vm-rule-e8974a9f5c70024e791f77fd541d4585.webp"},11586:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/new-game-settings-0add9142b13bcdc2ae0a7c7c5003bbb5.webp"},97265:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/store-upload-7208f6af355be0579784ecfc8e66ff8f.webp"}}]);